# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

インスタグラム投稿を効率化するWEBアプリケーションです。写真のAI加工と投稿文章の自動生成を行います。

## 現在の実装状況

### ✅ 実装完了済み機能
- **基本サーバー構成**: Node.js + Express サーバー（server.js）
- **写真アップロード機能**: Multer による画像ファイルアップロード
- **Gemini API連携**: Google Generative AI による画像解析と文章生成
- **画像処理機能**: Sharp による1:1アスペクト比への自動トリミング
- **WEBインターフェース**: Tailwind CSS を使用したレスポンシブUI
- **環境変数管理**: dotenv による設定管理（.env.example提供済み）
- **GitHub Pages**: デモページの公開
- **Vercel対応**: Vercel Functions を使用したサーバーレスデプロイ対応
- **画像圧縮機能**: クライアント側での自動画像圧縮（4MB制限対応）
- **エラーハンドリング改善**: 413エラーやタイムアウトの適切な処理

### 🔧 現在の技術仕様

#### ファイル構成
```
instagram投稿自動生成/
├── server.js           # Express サーバー（ローカル開発用）
├── api/
│   └── process.js      # Vercel Functions エンドポイント
├── index.html          # ランディングページ（GitHub Pages用）
├── public/
│   ├── index.html      # メインアプリケーション
│   └── app.js          # フロントエンドJavaScript（圧縮機能付き）
├── uploads/            # アップロードファイル保存（ローカルのみ）
├── vercel.json         # Vercel デプロイ設定
├── package.json        # 依存関係管理
├── .env.example        # 環境変数テンプレート
└── .env                # 実際の環境変数（Git除外）
```

#### 依存関係
- **express**: ^4.18.2 (WEBサーバー)
- **multer**: ^1.4.5-lts.1 (ファイルアップロード)
- **sharp**: ^0.33.0 (画像処理)
- **dotenv**: ^16.3.1 (環境変数)
- **cors**: ^2.8.5 (CORS設定)
- **@google/generative-ai**: ^0.5.0 (Gemini API)
- **nodemon**: ^3.0.2 (開発用)

#### API エンドポイント
- `POST /api/process`: 画像処理と文章生成（統合エンドポイント）
  - ローカル: Express サーバー経由
  - Vercel: Functions 経由（メモリストレージ使用）

#### 環境変数
- `GEMINI_API_KEY`: Gemini API キー（必須）
- `PORT`: サーバーポート（ローカルのみ、デフォルト: 3000）
- `MAX_FILE_SIZE`: 最大ファイルサイズ（ローカル: 10MB、Vercel: 4MB）
- `UPLOAD_DIR`: アップロードディレクトリ（ローカルのみ: uploads）

## 機能仕様

### 基本機能
- ✅ 写真のアップロード機能
- ✅ Gemini API連携による写真の解析
- ✅ 被写体を中心に配置し、1:1のアスペクト比でトリミング
- ✅ 写真に応じた投稿用文章の自動生成
- ✅ 加工後画像のダウンロード機能
- ✅ 生成された文章のコピー機能

### ユーザー選択オプション
- **文章のテイスト**: 「まじめ」「ユーモア」「キラキラ」から選択
- **ハッシュタグの量**: 「多い」「普通」「少ない」から選択

### 将来実装予定
- WEBアプリから直接インスタグラムへの投稿機能
- 複数画像の一括処理機能
- 生成結果の履歴管理

## 開発・運用コマンド

### 開発環境
```bash
npm run dev    # 開発サーバー起動（nodemon使用）
npm start      # 本番サーバー起動
```

### 初期セットアップ
1. `npm install` でパッケージインストール
2. `.env.example` を `.env` にコピー
3. `.env` にGemini API キーを設定
4. `npm run dev` で開発サーバー起動

## 開発方針

- **段階的実装**: 一気に進めず、ステップバイステップで開発する
- **動作確認**: 各ステップ完了時に動作確認を必須とする
- **コメント**: プログラムには必ず丁寧なコメントを記載する
- **日本語対応**: すべてのやりとりは日本語で行う

## 技術スタック

### フロントエンド
- **HTML/CSS/JavaScript**: バニラJavaScript（React未使用）
- **スタイリング**: Tailwind CSS（CDN）
- **画像処理**: Canvas API（client-side）
- **画像圧縮**: Canvas を使用した自動圧縮（4MB以上の場合）

### バックエンド
- **サーバー**: Node.js + Express
- **AI API**: Gemini Pro Vision API
- **画像処理**: Sharp（server-side）
- **ファイル管理**: Multer

### インフラ・デプロイ
- **開発**: ローカル環境（port 3000）
- **デモ**: GitHub Pages（静的ページのみ）
- **本番**: Vercel（サーバーレス関数）
  - リージョン: 東京（hnd1）
  - 制限: 10秒タイムアウト、4.5MBリクエストサイズ
- **API制限**: Gemini APIの無料枠利用

## 重要な注意事項

- **セキュリティ**:
  - Gemini APIキーは環境変数で管理、絶対にコミットしない
  - アップロードファイルは適切にフィルタリング済み
  - Vercelではメモリストレージを使用（ディスク書き込みなし）
- **API制限**:
  - Gemini Pro Vision APIの無料枠制限に注意
  - Vercel無料プラン: 10秒タイムアウト、4.5MBリクエスト制限
- **ファイル管理**:
  - uploads/ ディレクトリは Git 除外設定済み（ローカルのみ）
  - Vercelではメモリ内で処理、Data URLで返却
- **動作テスト**: 各機能実装後は必ず動作テストを行う
- **ユーザビリティ**: 直感的で使いやすい設計を重視

## Vercel デプロイ手順

1. GitHubリポジトリをVercelにインポート
2. 環境変数設定: `GEMINI_API_KEY` のみ必要
3. デプロイ設定:
   - Framework Preset: Other
   - Build Command: なし
   - Install Command: npm install
4. デプロイ実行

## 今後実装予定の機能

### 優先度: 高
- **エラー通知の改善**: より分かりやすいエラーメッセージ
- **処理状況の可視化**: プログレスバーの実装
- **画像プレビューの最適化**: アスペクト比の事前確認

### 優先度: 中
- **履歴機能**: 過去の生成結果を保存・閲覧
- **テンプレート機能**: よく使う設定の保存
- **バッチ処理**: 複数画像の一括処理
- **カスタムハッシュタグ**: ユーザー定義のハッシュタグセット

### 優先度: 低
- **Instagram API連携**: 直接投稿機能（OAuth認証必要）
- **画像エフェクト**: フィルターやエフェクトの追加
- **統計機能**: 利用状況の分析
- **多言語対応**: 英語以外の言語サポート

## 既知の課題

### 解決済み
- ✅ Vercel 413エラー: クライアント側圧縮で対応
- ✅ favicon 404エラー: Data URL で解決
- ✅ ファイルサイズ制限: UIに明記

### 未解決
- レスポンシブデザインの微調整が必要
- 非常に大きな画像（10MB以上）の処理が遅い
- Gemini API のレート制限への対応が未実装